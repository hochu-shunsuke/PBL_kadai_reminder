<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            margin: 15px
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h4>設定 & 連携</h4>
        <p class="text-muted">Tasksリストと自動実行の設定を行います。</p>
        <div id="alert" class="alert d-none"></div>
        <form onsubmit="return submitForm(this)">
            <div class="mb-3">
                <label>Tasksリスト名</label>
                <input type="text" class="form-control" id="listName" required>
            </div>
            <div class="row">
                <div class="col-6 mb-3">
                    <label>実行時間(時)</label>
                    <input type="number" class="form-control" id="hour" min="0" max="23" required>
                </div>
                <div class="col-6 mb-3">
                    <label>削除猶予(日)</label>
                    <input type="number" class="form-control" id="days" min="7" required>
                </div>
            </div>
            <button id="btn" type="submit" class="btn btn-primary w-100">設定を保存して連携</button>
        </form>
    </div>
    <script>
        // 初期値読み込み
        google.script.run.withSuccessHandler(v => {
            document.getElementById('listName').value = v.taskListName;
            document.getElementById('hour').value = v.triggerHour;
            document.getElementById('days').value = v.cleanupDays;
        }).getTasksSettingsForHtml();

        function submitForm(f) {
            const b = document.getElementById('btn');
            const a = document.getElementById('alert');
            b.disabled = true; b.innerText = '処理中...'; a.classList.add('d-none');

            const data = {
                taskListName: document.getElementById('listName').value,
                triggerHour: document.getElementById('hour').value,
                cleanupDays: document.getElementById('days').value
            };

            google.script.run
                .withSuccessHandler(() => {
                    a.className = 'alert alert-success'; a.innerText = '✅ 完了しました！'; a.classList.remove('d-none');
                    setTimeout(() => google.script.host.close(), 1500);
                })
                .withFailureHandler((e) => {
                    a.className = 'alert alert-danger'; a.innerText = 'エラー: ' + e.message; a.classList.remove('d-none');
                    b.disabled = false; b.innerText = '設定を保存して連携';
                })
                .saveTasksDataFromHtml(data); // Utils.gsの関数呼び出し
            return false;
        }
    </script>
</body>

</html>